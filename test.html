<div id="output"></div>
<iframe
  id="iframe"
  srcdoc="<div style = 'width: 100%; height: 100%;background-color: red;'><p>test</p></div>"
  width="1000px"
  height="1000px"
></iframe>

<script>
  async function pasteHandler(event) {
    console.log("pasteHandler", event);
    let clipboardData = event.clipboardData || window.clipboardData;
    if (!clipboardData) return;

    const item = document.createElement("div");

    // Check if we can directly access clipboard items (modern browsers)
    if (clipboardData.items) {
      // Process clipboard items directly
      const items = Array.from(clipboardData.items);

      // First, get the HTML content
      let htmlContent = "";
      for (const dataItem of items) {
        if (dataItem.type === "text/html") {
          htmlContent = await new Promise((resolve) => {
            dataItem.getAsString((string) => resolve(string));
          });
          break;
        }
      }

      // Set the initial HTML
      item.innerHTML = htmlContent || clipboardData.getData("text/html");

      // Find all images
      const images = item.querySelectorAll("img");
      console.log("images", images);

      // Process each image
      for (let i = 0; i < images.length; i++) {
        const img = images[i];

        // Check if there's a corresponding image file in clipboard items
        for (const dataItem of items) {
          if (dataItem.type.startsWith("image/")) {
            try {
              // Get image as blob
              const blob = dataItem.getAsFile();
              if (blob) {
                // Convert to base64
                const reader = new FileReader();
                await new Promise((resolve) => {
                  reader.onloadend = function () {
                    img.src = reader.result; // Replace with base64 data
                    resolve();
                  };
                  reader.readAsDataURL(blob);
                });

                // Move to next image after successful conversion
                break;
              }
            } catch (e) {
              console.error("Error processing clipboard image:", e);
            }
          }
        }
      }
    } else {
      // Fallback to old method
      const htmlContent = clipboardData.getData("text/html");
      item.innerHTML = htmlContent;

      // Find all images in the pasted content
      const images = item.querySelectorAll("img");
      console.log("images", images);

      // For fallback, we'll just keep the original image sources
      // as we can't access file:// URLs due to CORS restrictions
    }

    if (event.srcElement.nextSibling) {
      event.srcElement.parentNode.insertBefore(
        item,
        event.srcElement.nextSibling
      );
    } else {
      event.srcElement.parentNode.appendChild(item);
    }
  }
  document.addEventListener("paste", pasteHandler);

  const iframe = document.getElementById("iframe");

  // iframe이 로드된 후 실행되도록 보장
  iframe.addEventListener("load", () => {
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

    // 예: body에 paste 이벤트 리스너 등록
    iframeDoc.addEventListener("paste", pasteHandler);

    iframeDoc.addEventListener("click", pasteHandler);
  });
</script>

